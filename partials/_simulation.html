<!--
This is the scenario simulation page. This page runs scenarios and shows data
in the form of maps and charts. This page is still a WIP.
-->
<div class="sim_outer_boundary">
    <div class="sim_controls">
        <img class="sim_button" id="run" alt="run" title="run simulation" src="img/sim_buttons/run.svg"/>
        <img class="sim_button" id="pause" alt="pause" title="pause simulation" src="img/sim_buttons/pause.svg"/>
        <img class="sim_button" id="reset" alt="restart" title="restart simulation" src="img/sim_buttons/restart.svg"/>
        <img class="sim_button" id="step" alt="step" title="step through 1 iteration" src="img/sim_buttons/step.svg"/>
        <img class="sim_button" id="stop" alt="stop" title="stop simulation" src="img/sim_buttons/stop.svg"/>
<span id="sim_status" style="float:right; margin-right: 30px; line-height: 32px; text-shadow: 1px 1px 1px #fff">
<img src="img/csv_load.gif" alt="loading" />
Initializing data load...</span>
    </div>
    <div class="sim_screen" id="screen">
    <div id="ts-holder">
        <div id="ts_canvas"></div>
    </div>

    <div id="map-holder">

        <div class="map_info"></div>
            <div class="" id="map_canvas" style="width:95%; margin: 0 auto">
                <table class="map_legend" cellspacing="5">
                    <tr><th colspan="2"><strong>Legend</strong></th></tr>
                    <tr><td>S</td><td style="background: blue">&nbsp;&nbsp;</td></tr>
                    <tr><td>E</td><td style="background: yellow">&nbsp;&nbsp;</td></tr>
                    <tr><td>I</td><td style="background: red">&nbsp;&nbsp;</td></tr>
                    <tr><td>R</td><td style="background: green">&nbsp;&nbsp;</td></tr>
                </table>
                <strong class="data_select_title">Data Select</strong>
                <select id="data_select">
                    <option value="I">I</option>
                    <option value="S">S</option>
                    <option value="E">E</option>
                    <option value="R">R</option>
                </select>
            </div>

    </div>
        <div class="sim_time_series"> 
	       <div id="ts_settings"></div>
        </div>
        <table class="map_legend_max" cellspacing="5" style="display:none">
                    <tr><th colspan="2"><strong>Legend</strong></th></tr>
                    <tr><td>S</td><td style="background: blue">&nbsp;&nbsp;</td></tr>
                    <tr><td>E</td><td style="background: yellow">&nbsp;&nbsp;</td></tr>
                    <tr><td>I</td><td style="background: red">&nbsp;&nbsp;</td></tr>
                    <tr><td>R</td><td style="background: green">&nbsp;&nbsp;</td></tr>
        </table>
    </div>
</div>
<script type="text/javascript">
    var GRAPH_ARR = [];
    function graphAdd(region) {
        GRAPH_ARR.push(region);
        scen.setGraph('ts_canvas', "I", GRAPH_ARR);

        scen.initGraph();
    }
    function graphRemove(region) {
        for (var i = 0; i < GRAPH_ARR.length; i++) {
            if (GRAPH_ARR[i] === region) {
                GRAPH_ARR.splice(i,1);
                scen.setGraph('ts_canvas', DATA_SELECT, GRAPH_ARR);

                scen.initGraph();
                break;
            }
        }
    }
    var DATA_SELECT = "I";
    var CANVAS_WIDTH;
    var CANVAS_HEIGHT;
    var map;
    var big_map; // for maximized map
    var IS_RUNNING = false;
    var delay = (function(){
        var timer = 0;
        return function(callback, ms){
        clearTimeout (timer);
        timer = setTimeout(callback, ms);
        };
    })();

    // Display the map's info
    $(".map_info").html("<strong>Country: </strong>"+scen.getCountry()+"&nbsp;&nbsp;<strong>Level: </strong>"+scen.getLevel());
    function simulationLoaded() {
       CANVAS_HEIGHT = CANVAS_WIDTH = $("#map-holder").width()*0.95;
       //CANVAS_HEIGHT = $("#map-holder").height()*0.8;

       map = Raphael("map_canvas", CANVAS_WIDTH, CANVAS_HEIGHT);
       scen.setGraph('ts_canvas', 'I', []);
       scen.setMap(map).resizeMap({x: CANVAS_WIDTH, y: CANVAS_HEIGHT}).initGraph();
       setTimeout(function() { mapInit.call(scen) }, 500); // Make regions clickable
       scen.setDelay(600);
       scen.setLoadCallback(function() {
	   $('#sim_status').html('<img src="img/csv_load.gif" alt="loading" />' + " Loading.... "+this.output.I.length+" cycles loaded");
       });
       scen.setLoadedCallback(function() {
	       $('#sim_status').html("Finished loading "+this.output.I.length+" cycles");
       });
    }

    function mapInit() {
        var map_ref = this.mapData;
        var count = 0;
        for (region in map_ref.regions) (function(region) {
            count++;
            map_ref.regions[region].attr({fill: "#fff"});
            var old_sw = 1,
                clicked = false;
           /* map_ref.regions[region].hover(function (event) {
                var attr = this.attr();
                old_sw = attr['stroke-width'] ? attr['stroke-width'] : 1;
                this.attr({stroke: "#FF0000", 'stroke-width': 4});
                clicked = false;
            }, function (event) {
                if (!clicked) {
                    this.attr({stroke: '#000', 'stroke-width':old_sw});
                }
            });*/
            map_ref.regions[region].click(function (event) {
                var attr = this.attr();
                clicked = true;

                if (attr['stroke-width'] === 3) {
                    graphRemove(region);
                    this.attr({'stroke-width': 1, stroke: "#000"});
                } else {
                    graphAdd(region);
                    this.attr({'stroke-width': 3, stroke: "#000"});
                }
            });
            
        }(region));

        // Not ready yet, try again...
        if (count === 0) {
            var that = this;
            setTimeout(function() { mapInit.call(that); }, 500);
        }
    }
    
    // setup sim button action listeners
    $("#run").click(function(){
	if (IS_RUNNING) {
	    scen.resume();
	} else {
        scen.run();
	    IS_RUNNING = true;
	}
    });
    
    $("#pause").click(function(){
        scen.pause();
    });

    $("#reset, #stop").click(function(){
        scen.reset();
	   IS_RUNNING = false;
    });

    $("#data_select").change(function(){
        DATA_SELECT = $("#data_select").val();
        scen.setMap(map, DATA_SELECT);
    });
</script>
